<!-- app/templates/tree.html -->
{% extends "base_template.html" %}

{% block content %}
<h1 class="text-center mb-4">Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© Ø§Ù„Ø­Ø³Ù†Ø©</h1>

<!-- ğŸ”˜ Boutons de contrÃ´le -->
<div class="header-actions text-center mb-3">
  <a href="/add" class="btn btn-success me-2">â• Ø¥Ø¶Ø§ÙØ© ÙØ±Ø¯ Ø¬Ø¯ÙŠØ¯</a>
  <button id="fullscreenBtn" class="btn btn-secondary me-2">ğŸ–¼ï¸ Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©</button>
  <button id="centerBtn" class="btn btn-info me-2">ğŸ¯ ØªÙˆØ³ÙŠØ·</button>
  <button id="pngBtn" class="btn btn-warning me-2">â¬‡ï¸ ØªØµØ¯ÙŠØ± PNG</button>
  <button id="svgBtn" class="btn btn-warning me-2">â¬‡ï¸ ØªØµØ¯ÙŠØ± SVG</button>
  <input id="treeSearch" type="text" class="form-control d-inline-block w-auto" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù…" />
</div>

<!-- ğŸ“ Conteneur principal de lâ€™arbre -->
<!-- ğŸ§  Ce conteneur est lâ€™Ã©lÃ©ment DOM que D3.js va cibler avec `#wrapper` -->
<main id="wrapper" class="tree-wrapper mb-5" style="width: 100%; height: 70vh; position: relative;"></main>

<!-- ğŸ§ Modal Bootstrap -->
<button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#personModal">
  CrÃ©er une personne
</button>

<div class="modal fade" id="personModal" tabindex="-1" aria-labelledby="personModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="personModalLabel">CrÃ©er une personne</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        {% include "tree_form.html" %}
      </div>
    </div>
  </div>
</div>

<!-- ğŸ§  Importer dynamiquement tree.js pour charger lâ€™arbre -->
<!-- Ce script doit apparaÃ®tre AVANT les modules JS importÃ©s dans extra_js -->
<script type="module">
  document.addEventListener("DOMContentLoaded", async () => {
    console.log("ğŸ“¦ DOM complÃ¨tement chargÃ© â†’ import de tree.js");

    try {
      // tree.js doit initialiser lâ€™arbre dans le conteneur #wrapper
      await import("/static/js/tree.js");
      console.log("âœ… tree.js importÃ© avec succÃ¨s");
    } catch (err) {
      console.error("âŒ Erreur lors de l'import de tree.js :", err);
    }
  });
</script>

{% endblock %}

<!-- ğŸ”§ Scripts utilitaires de test dâ€™interaction des boutons -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const test = (id, label) => {
    const el = document.getElementById(id);
    if (el) {
      el.addEventListener("click", () => {
        console.log(`ğŸŸ¢ ${label} cliquÃ© (ID: #${id})`);
      });
    } else {
      console.warn(`âŒ Ã‰lÃ©ment non trouvÃ© : #${id}`);
    }
  };

  test("fullscreenBtn", "Bouton plein Ã©cran");
  test("centerBtn", "Bouton centrer");
  test("pngBtn", "Bouton export PNG");
  test("svgBtn", "Bouton export SVG");

  const search = document.getElementById("treeSearch");
  if (search) {
    search.addEventListener("input", () => {
      console.log(`ğŸ” Recherche : ${search.value}`);
    });
  } else {
    console.warn("âŒ Champ recherche introuvable : #treeSearch");
  }
});
</script>

{% block extra_js %}
<!-- ğŸ§  CSS D3.js et personnalisations -->
<style>
/* ğŸŒ³ Style des nÅ“uds D3.js */
.node circle {
  fill: #999;
  stroke: steelblue;
  stroke-width: 2px;
}
.node text {
  font: 12px sans-serif;
}
.link {
  fill: none;
  stroke: #ccc;
  stroke-width: 2px;
}

/* ğŸ¨ Couleurs par gÃ©nÃ©ration */
.ft-node {
  border-radius: 5px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
.ft-gener-0 { background-color: #6a0dad; }
.ft-gener-1 { background-color: #1e90ff; }
.ft-gener-2 { background-color: #32cd32; }
.ft-gener-3 { background-color: #ff8c00; }
.ft-gener-4 { background-color: #ff1493; }

.node--highlight {
  stroke: #ff0000 !important;
  stroke-width: 4px;
}
</style>

<!-- ğŸ§  Modules JavaScript utilisÃ©s dans tree.js -->
<script type="module" src="{{ url_for('static', filename='js/tree/utils.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/tree/d3-tree.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/tree/core.js') }}"></script>

<!-- âœ… tree.js est maintenant chargÃ© dynamiquement, donc cette ligne reste commentÃ©e -->
<!-- <script type="module" src="{{ url_for('static', filename='js/tree.js') }}"></script> -->
{% endblock %}
